<ui:FluentWindow
    x:Class="ViveGui.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:conv="clr-namespace:ViveGui.Converters"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:ViveGui.ViewModels"
    Title="ViVeTool GUI Wrapper"
    Width="850"
    Height="650"
    ExtendsContentIntoTitleBar="True"
    ResizeMode="CanResize"
    SnapsToDevicePixels="True"
    UseLayoutRounding="True"
    WindowBackdropType="Mica">

    <Window.Resources>
        <conv:StatusToBrushConverter x:Key="StatusToBrushConverter" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <!--  Custom TitleBar  -->
            <RowDefinition Height="Auto" />
            <!--  Input Area  -->
            <RowDefinition Height="Auto" />
            <!--  Data Grid  -->
            <RowDefinition Height="*" />
            <!--  Action Area  -->
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  0. 自定义标题栏 (WinUI 风格必须)  -->
        <ui:TitleBar
            Title="ViVeTool GUI Wrapper"
            Grid.Row="0" />

        <!--  1. Input Area  -->
        <Grid
            Grid.Row="1"
            Margin="20,10,20,15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <ComboBox
                Grid.Column="0"
                Width="120"
                Margin="0,0,10,0"
                VerticalAlignment="Center"
                ItemsSource="{Binding ActionTypes}"
                SelectedItem="{Binding SelectedAction}" />

            <!--  使用 PlaceholderText 代替 ToolTip，更符合现代 UI  -->
            <ui:TextBox
                Grid.Column="1"
                VerticalAlignment="Center"
                Icon="{ui:SymbolIcon Edit16}"
                PlaceholderText="Enter IDs here (e.g. '12345 67890+1')"
                Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}" />

            <!--  普通操作按钮  -->
            <ui:Button
                Grid.Column="2"
                Margin="10,0,0,0"
                Command="{Binding AddCommand}"
                Content="Add to Queue"
                Icon="{ui:SymbolIcon Add24}" />
        </Grid>

        <!--  2. Data Grid  -->
        <DataGrid
            Grid.Row="2"
            Margin="20,0,20,0"
            AutoGenerateColumns="False"
            Background="{ui:ThemeResource CardBackgroundFillColorSecondaryBrush}"
            BorderBrush="{ui:ThemeResource ControlElevationBorderBrush}"
            BorderThickness="1"
            CanUserAddRows="False"
            HeadersVisibility="Column"
            IsReadOnly="True"
            ItemsSource="{Binding Instructions}"
            RowDetailsVisibilityMode="Visible">

            <DataGrid.RowStyle>
                <Style
                    BasedOn="{StaticResource {x:Type DataGridRow}}"
                    TargetType="DataGridRow">
                    <Setter Property="VerticalContentAlignment" Value="Center" />
                    <Setter Property="Background" Value="{Binding Status, Converter={StaticResource StatusToBrushConverter}}" />
                </Style>
            </DataGrid.RowStyle>

            <DataGrid.Columns>
                <DataGridTextColumn
                    Width="2*"
                    Binding="{Binding GetIdString}"
                    Header="ID &amp; Variant" />

                <DataGridTemplateColumn
                    Width="1*"
                    Header="Action">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <!--  使用卡片式标签展示 Action  -->
                            <Border
                                Padding="8,2"
                                HorizontalAlignment="Left"
                                Background="{ui:ThemeResource ControlSolidFillColorDefaultBrush}"
                                CornerRadius="4">
                                <TextBlock Text="{Binding Action}" />
                            </Border>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn
                    Width="1.5*"
                    Binding="{Binding Status}"
                    Header="Status" />

                <!--  操作列: 使用图标按钮  -->
                <DataGridTemplateColumn
                    Width="Auto"
                    Header="Ops">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ui:Button
                                Padding="5"
                                Appearance="Secondary"
                                Background="Transparent"
                                BorderThickness="0"
                                Command="{Binding DataContext.RemoveRowCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                CommandParameter="{Binding}"
                                Icon="{ui:SymbolIcon Delete24}"
                                ToolTip="Remove" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>

            <DataGrid.RowDetailsTemplate>
                <DataTemplate>
                    <!--  使用 CardControl 或者带有圆角的 Border  -->
                    <Border
                        Margin="10,5,10,10"
                        Padding="10"
                        Background="{ui:ThemeResource LayerOnMicaBaseAltFillColorDefaultBrush}"
                        CornerRadius="4">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <ui:SymbolIcon
                                Margin="0,0,10,0"
                                VerticalAlignment="Top"
                                Foreground="Gray"
                                Symbol="Code24" />

                            <TextBox
                                Grid.Column="1"
                                MaxHeight="150"
                                Background="Transparent"
                                BorderThickness="0"
                                FontFamily="Consolas"
                                IsReadOnly="True"
                                Text="{Binding OutputText, Mode=OneWay}"
                                TextWrapping="Wrap"
                                VerticalScrollBarVisibility="Auto" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </DataGrid.RowDetailsTemplate>
        </DataGrid>

        <!--  3. Action Area  -->
        <Border
            Grid.Row="3"
            Padding="20,15"
            Background="{ui:ThemeResource SolidBackgroundFillColorBaseBrush}"
            BorderBrush="{ui:ThemeResource SurfaceStrokeColorDefaultBrush}"
            BorderThickness="0,1,0,0">
            <StackPanel
                HorizontalAlignment="Right"
                Orientation="Horizontal">

                <!--  清除按钮：次要操作  -->
                <ui:Button
                    MinWidth="100"
                    Margin="0,0,10,0"
                    Appearance="Secondary"
                    Command="{Binding ClearCommand}"
                    Content="Clear All"
                    Icon="{ui:SymbolIcon Dismiss24}" />

                <!--  执行按钮：主要操作 (高亮显示)  -->
                <ui:Button
                    MinWidth="120"
                    Appearance="Primary"
                    Command="{Binding RunCommand}"
                    Content="Execute Batch"
                    Icon="{ui:SymbolIcon Play24}" />
            </StackPanel>
        </Border>
    </Grid>
</ui:FluentWindow>
